{% extends 'layouts/base.html' %}
{% load bootstrap4 static i18n %}
{% block extracss %}
    <link href="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.css' %}" rel="stylesheet">
    <style>
        #map {
            height: 1253px;
        }

    </style>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="card transparent">
                <div class="card-header">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-2">
                                        <h2 class="text-primary text-bold">{% translate "Filter by" %}</h2>
                                    </div>
                                    {% for field in form %}
                                    <div class="col-2">
                                        {% bootstrap_field field %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="overlay-wrapper">
                        <div class="row">
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body" >
                                        <div id="map" style="height: 600px !important;"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body" >

                                        <div class="card-body table-responsive">
                                            <table id="table" class="table table-bordered">
                                                <thead>
                                                <tr>
                                                    <th>{% translate 'Region' %}</th>
                                                    <th>{% translate 'Task Completed' %}</th>
                                                    <th>{% translate 'Percentage' %}</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>


                                    </div>
                                </div>
                            </div>


                        </div>
                        {% comment %} <div class="overlay z-index1000" id="statistics-spin">
                            <i class="fas fa-10x fa-sync-alt fa-spin">
                            </i>
                        </div> {% endcomment %}
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}
{% block javascript %}
    {{ block.super }}
    <script src="{% static 'plugins/mapbox-gl-js/v2.6.1/mapbox-gl.js' %}"></script>
    <script>
        let statistics_spin = $('#statistics-spin');
        let markers = [];

        mapboxgl.accessToken = '{{ access_token }}';
        if (!mapboxgl.supported()) {
            alert('Your browser does not support Mapbox GL');
        }
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [{{ lng }}, {{ lat }}],
            zoom: {{ zoom }}
        });

        const bounds = [
            {{ ws_bound }}, // [west, south]
            {{ en_bound }}  // [east, north]
        ];
        // Set the map's max bounds.
        map.setMaxBounds(bounds);


        const places = {
            'type': 'FeatureCollection',
            'features': [
                {
                    'type': 'Feature',
                    'properties': {
                        'description': "Ford's Theater",
                        'icon': 'theatre'
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [0.8332327892880187, 8.770198211475261]
                    }
                }

            ]
        };

        map.on('load', function () {

            map.addSource('places', {
'type': 'geojson',
'data': places
});


            map.addLayer(
                {
                    'id': 'country-boundaries',
                    'source': {
                        'type': 'vector',
                        'url': 'mapbox://mapbox.country-boundaries-v1',
                    },
                    'source-layer': 'country_boundaries',
                    'type': 'fill',
                    'paint': {
                        'fill-color': '#00FFFF',
                        'fill-opacity': 0.2,
                    },
                },
                'country-label'
            );


            map.setFilter('country-boundaries', [
                "in",
                "iso_3166_1_alpha_3",
                '{{ country_iso_code }}',
            ]);

            setTimeout(function () {
                statistics_spin.hide();
            }, 1000);
        });

        {% comment %} {% for subproject in subprojects %}
            let marker = new mapboxgl.Marker()
                .setLngLat([{{ subproject.administrative_level.longitude }}, {{ subproject.administrative_level.latitude }}])
                .addTo(map);
            markers.push(marker);
        {% endfor %} {% endcomment %}



    </script>
{% endblock %}
{% block select2 %}
    <script src="{% static 'js/dynamicRegionSelector.js' %}"></script>
    <script type="text/javascript">
        {% for field in list_fields %}

            $(document).on("change", ("."+"{{ field }}"), function (event) {
                let r = "select2-id_"+"{{ field }}"+"-container";
                selected = document.getElementById(r).innerHTML.split("</span>")[1].toUpperCase();
                $.ajax({
                    type: 'GET',
                    url: `{% url 'dashboard:grm:get_tasks_diagnostics_view' %}`,
                    data: {
                        type: "{{ field }}",
                        sql_id: this.value
                    },
                    success: function (data) {
                        let table = document.getElementById("table");
                        if(data.search_by_locality){
                            table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>{% translate '`+data.type+`' %}</th>
                                    <th>{% translate 'Task Completed' %}</th>
                                    <th>{% translate 'Percentage' %}</th>
                                </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        <td>`+selected.toUpperCase()+`</td>
                                        <td>`+data.nbr_tasks_completed+`</td>
                                        <td>`+(data.percentage_tasks_completed).toFixed(2)+`%</td>
                                    </tr>
                                </tbody>
                            `;
                        }else{
                            table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>{% translate 'Region' %}</th>
                                    <th>{% translate 'Task Completed' %}</th>
                                    <th>{% translate 'Percentage' %}</th>
                                </tr>
                                </thead>

                                <tbody>
                            `;
                            console.log(data.regions)
                            
                            for (const [key, value] of Object.entries(data.regions)) {
                                console.log(key, value);
                                table.innerHTML += `
                                <tr>
                                    <td>`+key+`</td>
                                    <td>`+value.nbr_tasks_completed+`</td>
                                    <td>`+(value.percentage_tasks_completed).toFixed(2)+`%</td>
                                </tr>
                                `;
                            }

                            table.innerHTML += `
                            </tbody>
                            `;
                        }
                        
                         {% comment %} if (data.length > 0) {
                            data = data.slice(1);
                            data.push(administrative_levels);
                        }   {% endcomment %}
                    },
                    error: function (data) {
                        alert(error_server_message + "Error " + data.status);
                    }
                });
            });

            $(("#id_"+"{{ field }}")).select2({
                placeholder: `{% translate field|title %}`,
                allowClear: true
            });
        {% endfor %}


        
        {% comment %} $('b[role="presentation"]').hide(); {% endcomment %}
        $('.select2-selection__arrow').append(
            '<i class="fas fa-chevron-circle-down text-primary" style="margin-top:12px;"></i>');

    </script>
{% endblock select2 %}